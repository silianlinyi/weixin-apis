{"name":"Weixin-api","tagline":"微信API For Nodejs","body":"## 微信 API For Nodejs\r\n\r\n### 交流\r\n\r\n欢迎大家加入QQ群：172342609 《微信 API For Nodejs》专用交流群\r\n\r\n### 快速开发\r\n\r\n**第一步** 新建一个express项目\r\n\r\n```\r\nD:\\Dcloud\\workspace>express -s -e weixin-api\r\n\r\n   create : weixin-api\r\n   create : weixin-api/package.json\r\n   create : weixin-api/app.js\r\n   create : weixin-api/public/javascripts\r\n   create : weixin-api/public\r\n   create : weixin-api/routes\r\n   create : weixin-api/routes/index.js\r\n   create : weixin-api/routes/user.js\r\n   create : weixin-api/views\r\n   create : weixin-api/views/index.ejs\r\n   create : weixin-api/public/images\r\n   create : weixin-api/public/stylesheets\r\n   create : weixin-api/public/stylesheets/style.css\r\n\r\n   install dependencies:\r\n     $ cd weixin-api && npm install\r\n\r\n   run the app:\r\n     $ node app\r\n```\r\n\r\n**第二步** 安装weixin-apis模块\r\n\r\n> 注意这里这里是weixin-apis，不是weixin-api，因为npmjs.org网站已经有weixin-api项目，所以我就在后面加了一个s。\r\n\r\n（1）方式一 \r\n\r\n在项目根目录下的package.json文件添加声明：\r\n\r\n```\r\n\"dependencies\": {\r\n\t\"express\": \"3.4.2\",\r\n\t\"ejs\": \"*\",\r\n\t\"weixin-apis\": \"*\"\r\n}\r\n```\r\n\r\n进入项目根目录，运行命令 `npm install`，对于国内用户，经常安装失败，至于为什么，你懂得~\r\n\r\n在这里推荐使用`cnpm`，关于`cnpm`可以查看http://cnpmjs.org/。\r\n\r\n通过cnpm安装weixin-apis，运行命令`cnpm install`\r\n\r\n（2）方式二\r\n\r\n进入项目根目录，运行命令 `npm install weixin-apis --save`或者`cnpm install weixin-apis --save`\r\n\r\n**第三步** 修改app.js文件，如下所示：\r\n\r\n```\r\nvar express = require('express');\r\nvar weixin = require('weixin-apis');\r\n\r\nvar app = express();\r\n\r\n// 微信接入配置\r\nweixin.configurate({\r\n\ttoken : '这是你的token',\r\n\tappid : '这是你的appid',\r\n\tsecret : '这是你的secret'\r\n});\r\n\r\n// 接入验证\r\napp.get('/verify', function(req, res) {\r\n\tif (weixin.checkSignature(req)) {\r\n\t\tres.send(200, req.query.echostr);\r\n\t} else {\r\n\t\tres.send(200, 'fail');\r\n\t}\r\n});\r\n// Start\r\napp.post('/verify', function(req, res) {\r\n\tweixin.loop(req, res);\r\n});\r\n\r\n// 监听文本消息\r\nweixin.on('textMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> textMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\tvar msg;\r\n\tswitch (data.content) {\r\n\t\tcase '文本':\r\n\t\t\tmsg = {\r\n\t\t\t\ttoUserName : data.fromUserName,\r\n\t\t\t\tfromUserName : data.toUserName,\r\n\t\t\t\tmsgType : 'text',\r\n\t\t\t\tcontent : '回复的消息内容（换行：在content中能够换行，微信客户端就支持换行显示）'\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase '图片':\r\n\t\t\tmsg = {\r\n\t\t\t\ttoUserName : data.fromUserName,\r\n\t\t\t\tfromUserName : data.toUserName,\r\n\t\t\t\tmsgType : 'image',\r\n\t\t\t\tmediaId : '通过上传图片文件，得到的id'\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase '语音':\r\n\t\t\tmsg = {\r\n\t\t\t\ttoUserName : data.fromUserName,\r\n\t\t\t\tfromUserName : data.toUserName,\r\n\t\t\t\tmsgType : 'voice',\r\n\t\t\t\tmediaId : '通过上传语音文件，得到的id'\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase '视频':\r\n\t\t\tmsg = {\r\n\t\t\t\ttoUserName : data.fromUserName,\r\n\t\t\t\tfromUserName : data.toUserName,\r\n\t\t\t\tmsgType : 'video',\r\n\t\t\t\ttitle : '视频消息的标题',\r\n\t\t\t\tdescription : '视频消息的描述',\r\n\t\t\t\tmediaId : '通过上传视频文件，得到的id'\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase '音乐':\r\n\t\t\tmsg = {\r\n\t\t\t\ttoUserName : data.fromUserName,\r\n\t\t\t\tfromUserName : data.toUserName,\r\n\t\t\t\tmsgType : 'music',\r\n\t\t\t\ttitle : \"音乐标题\",\r\n\t\t\t\tdescription : \"音乐描述\",\r\n\t\t\t\tmusicUrl : '音乐链接',\r\n\t\t\t\tthumbMediaId : '缩略图的媒体id，通过上传多媒体文件，得到的id'\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase '图文':\r\n\t\t\tvar articles = [];\r\n\t\t\tarticles[0] = {\r\n\t\t\t\ttitle : \"每个Web开发者必备的9个软技能\",\r\n\t\t\t\tdescription : \"每个Web开发者除了精通技术，还应必备以下9个软技能：交流、倾听、适应、合作、积极的态度、有职业道德、判断/辨别、批判性思维和自负管理等\",\r\n\t\t\t\tpicUrl : \"http://cms.csdnimg.cn/article/201404/01/5339fcde7d200.jpg\",\r\n\t\t\t\turl : \"http://www.csdn.net/article/2014-04-01/2819079-9-soft-skills-every-web-developer-should-master\"\r\n\t\t\t};\r\n\t\t\tarticles[1] = {\r\n\t\t\t\ttitle : \"轻松打造品牌轻应用：实时Web App开发框架Clouda\",\r\n\t\t\t\tdescription : \"Clouda是百度历时两年共同研发的开源App技术框架，基于Node.js，简单易用，完美结合BAE，具备跨终端、云端统一、随动反馈和全实时等新一代技术能力。许多传统企业产品都通过Clouda开发品牌轻应用实现互联网化转型。\",\r\n\t\t\t\tpicUrl : \"http://cms.csdnimg.cn/article/201403/07/53196741f0a1d_middle.jpg\",\r\n\t\t\t\turl : \"http://www.csdn.net/article/2014-03-07/2818676-baidu-clouda\"\r\n\t\t\t};\r\n\t\t\tmsg = {\r\n\t\t\t\ttoUserName : data.fromUserName,\r\n\t\t\t\tfromUserName : data.toUserName,\r\n\t\t\t\tmsgType : 'news',\r\n\t\t\t\tarticles : articles\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tmsg = {\r\n\t\t\t\ttoUserName : data.fromUserName,\r\n\t\t\t\tfromUserName : data.toUserName,\r\n\t\t\t\tmsgType : 'text',\r\n\t\t\t\tcontent : data.content\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t}\r\n\tweixin.sendMsg(msg);\r\n});\r\n\r\n// 监听图片消息\r\nweixin.on('imageMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> imageMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\tvar msg = {\r\n\t\ttoUserName : data.fromUserName,\r\n\t\tfromUserName : data.toUserName,\r\n\t\tmsgType : 'image',\r\n\t\tmediaId : data.mediaId\r\n\t};\r\n\tweixin.sendMsg(msg);\r\n});\r\n\r\n// 监听语音消息\r\nweixin.on('voiceMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> voiceMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\tvar msg = {\r\n\t\ttoUserName : data.fromUserName,\r\n\t\tfromUserName : data.toUserName,\r\n\t\tmsgType : 'voice',\r\n\t\tmediaId : data.mediaId\r\n\t};\r\n\tweixin.sendMsg(msg);\r\n});\r\n\r\n// 监听视频消息\r\nweixin.on('videoMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> videoMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\tvar msg = {\r\n\t\ttoUserName : data.fromUserName,\r\n\t\tfromUserName : data.toUserName,\r\n\t\tmsgType : 'video',\r\n\t\tmediaId : '-jI7RharH0_mhI9cN0gLDLrkXZYPbkzCTGcNQzuaRcT4PP2klByRb0RfaagZj_Ob'\r\n\t};\r\n\tweixin.sendMsg(msg);\r\n});\r\n\r\n// 监听地理位置消息\r\nweixin.on('locationMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> locationMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n});\r\n\r\n// 监听链接消息\r\nweixin.on('linkMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> linkMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n});\r\n\r\n// 监听关注事件\r\nweixin.on('subscribeEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> subscribeEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n});\r\n\r\n// 监听取消关注事件\r\nweixin.on('unsubscribeEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> unsubscribeEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n});\r\n\r\n// 监听上报地理位置事件\r\nweixin.on('locationEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> locationEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n});\r\n\r\n// 监听点击菜单拉取消息时的事件推送\r\nweixin.on('clickEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> clickEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n});\r\n\r\n// 监听点击菜单跳转链接时的事件推送\r\nweixin.on('viewEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> viewEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n});\r\n\r\n// 客服消息 - 文本\r\n//weixin.sendCustomMsg({\r\n//\ttoUserName : 'ojim5txO8ivc0Ff2LKW1nlUJ9hM4',\r\n//\tmsgType : 'text',\r\n//\tcontent : \"这是一段文本\"\r\n//}, function(err, res, body) {// 回调函数，可选\r\n//\tconsole.log(body);\r\n//});\r\n\r\n// 客服消息 - 图片\r\n//weixin.sendCustomMsg({\r\n//\ttoUserName: 'ojim5txO8ivc0Ff2LKW1nlUJ9hM4',\r\n//\tmsgType: 'image',\r\n//\tmediaId: 'QMzNj-GD7BI_VGiAqc5ONW2CnTDGfRmem1hVdK_nR1p-WEQEb_2W4jfARp5nFn1K'\r\n//}, function(err, res, body) {\r\n//\tconsole.log(body);\r\n//});\r\n\r\n// 客服消息 - 语音\r\n//weixin.sendCustomMsg({\r\n//\ttoUserName : 'ojim5txO8ivc0Ff2LKW1nlUJ9hM4',\r\n//\tmsgType : 'voice',\r\n//\tmediaId : '6XL3LGUAhcw9MEYbCzQq-k90j-9B_jxCD24M3uMqexqUljJlzJ7_w4BrjlQDwT3B'\r\n//}, function(err, res, body) {\r\n//\tconsole.log(body);\r\n//});\r\n\r\n// 客服消息 - 视频\r\n//weixin.sendCustomMsg({\r\n//\ttoUserName : 'ojim5txO8ivc0Ff2LKW1nlUJ9hM4',\r\n//\tmsgType : 'video',\r\n//\ttitle: '这是视频标题',\r\n//\tdescription: '这是视频描述',\r\n//\tmediaId : '-jI7RharH0_mhI9cN0gLDLrkXZYPbkzCTGcNQzuaRcT4PP2klByRb0RfaagZj_Ob'\r\n//}, function(err, res, body) {\r\n//\tconsole.log(body);\r\n//});\r\n\r\n// 客服消息 - 音乐\r\n//weixin.sendCustomMsg({\r\n//\ttoUserName : 'ojim5txO8ivc0Ff2LKW1nlUJ9hM4',\r\n//\tmsgType : 'music',\r\n//\ttitle : \"this is title\",\r\n//\tdescription : \"this is description\",\r\n//\tmusicUrl : \"http://xihumaker.jios.org/voice/welcome.mp3\",\r\n//\tHQMusicUrl : \"\",\r\n//\tthumbMediaId : \"QMzNj-GD7BI_VGiAqc5ONW2CnTDGfRmem1hVdK_nR1p-WEQEb_2W4jfARp5nFn1K\"\r\n//}, function(err, res, body) {\r\n//\tconsole.log(body);\r\n//});\r\n\r\n// 客服消息 - 图文\r\n//weixin.sendCustomMsg({\r\n//\ttoUserName : 'ojim5txO8ivc0Ff2LKW1nlUJ9hM4',\r\n//\tmsgType : 'news',\r\n//\r\n//\tarticles : [{\r\n//\t\ttitle : \"每个Web开发者必备的9个软技能\",\r\n//\t\tdescription : \"每个Web开发者除了精通技术，还应必备以下9个软技能：交流、倾听、适应、合作、积极的态度、有职业道德、判断/辨别、批判性思维和自负管理等\",\r\n//\t\tpicurl : \"http://cms.csdnimg.cn/article/201404/01/5339fcde7d200.jpg\",\r\n//\t\turl : \"http://www.csdn.net/article/2014-04-01/2819079-9-soft-skills-every-web-developer-should-master\"\r\n//\t}, {\r\n//\t\ttitle : \"轻松打造品牌轻应用：实时Web App开发框架Clouda\",\r\n//\t\tdescription : \"Clouda是百度历时两年共同研发的开源App技术框架，基于Node.js，简单易用，完美结合BAE，具备跨终端、云端统一、随动反馈和全实时等新一代技术能力。许多传统企业产品都通过Clouda开发品牌轻应用实现互联网化转型。\",\r\n//\t\tpicurl : \"http://cms.csdnimg.cn/article/201403/07/53196741f0a1d_middle.jpg\",\r\n//\t\turl : \"http://www.csdn.net/article/2014-03-07/2818676-baidu-clouda\"\r\n//\t}]\r\n//\r\n//}, function(err, res, body) {\r\n//\tconsole.log(body);\r\n//});\r\n\r\napp.listen(80);\r\n\r\n```\r\n\r\n\r\n### API\r\n\r\n#### weixin.configurate 微信接入配置\r\n\r\n```\r\nweixin.configurate({\r\n\ttoken : '这是你的token',\r\n\tappid : '这是你的appid',\r\n\tsecret : '这是你的secret'\r\n});\r\n```\r\n\r\n#### weixin.checkSignature 验证消息真实性\r\n\r\n```\r\n// 接入验证\r\napp.get('/verify', function(req, res) {\r\n\tif (weixin.checkSignature(req)) {\r\n\t\tres.send(200, req.query.echostr);\r\n\t} else {\r\n\t\tres.send(200, 'fail');\r\n\t}\r\n});\r\n```\r\n\r\n#### 监听文本消息\r\n\r\n```\r\nweixin.on('textMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> textMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听图片消息\r\n\r\n```\r\nweixin.on('imageMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> imageMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听语音消息\r\n\r\n```\r\nweixin.on('voiceMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> voiceMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听视频消息\r\n\r\n```\r\nweixin.on('videoMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> videoMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听地理位置消息\r\n\r\n```\r\nweixin.on('locationMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> locationMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听链接消息\r\n\r\n```\r\nweixin.on('linkMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> linkMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n\r\n#### 监听关注事件\r\n\r\n```\r\nweixin.on('subscribeEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> subscribeEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听取消关注事件\r\n\r\n```\r\nweixin.on('unsubscribeEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> unsubscribeEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听上报地理位置事件\r\n\r\n```\r\nweixin.on('locationEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> locationEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听点击菜单拉取消息时的事件推送\r\n\r\n```\r\nweixin.on('clickEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> clickEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n#### 监听点击菜单跳转链接时的事件推送\r\n\r\n```\r\nweixin.on('viewEventMsg', function(data) {\r\n\tconsole.log('>>>>>>>>> viewEventMsg emit >>>>>>>>>');\r\n\tconsole.log(data);\r\n\t// TODO\r\n});\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}